@page "/"
@using DocProcessor.Core.Interfaces
@using DocProcessor.Core.Enums
@inject IDocumentRequestRepository RequestRepository
@inject IBatchJobRepository BatchJobRepository
@rendermode InteractiveServer

<PageTitle>Dashboard - Document Processor Admin</PageTitle>

<h1>Dashboard</h1>

@if (_loading)
{
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Requests</h5>
                    <h2 class="card-text">@_totalRequests</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Queued</h5>
                    <h2 class="card-text">@_queuedRequests</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Completed</h5>
                    <h2 class="card-text">@_completedRequests</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Batch Jobs</h5>
                    <h2 class="card-text">@_totalBatches</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Requests</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Document</th>
                                <th>Mode</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in _recentRequests)
                            {
                                <tr>
                                    <td><a href="requests/@request.Id">@request.Id[..8]...</a></td>
                                    <td>@request.DocumentName</td>
                                    <td>@request.ProcessingMode</td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(request.Status)">
                                            @request.Status
                                        </span>
                                    </td>
                                    <td>@request.CreatedAt.ToString("g")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-secondary" @onclick="LoadDataAsync">
            <span class="bi bi-arrow-clockwise"></span> Refresh
        </button>
    </div>
}

@code {
    private bool _loading = true;
    private long _totalRequests;
    private int _queuedRequests;
    private int _completedRequests;
    private long _totalBatches;
    private List<DocProcessor.Core.Entities.DocumentRequest> _recentRequests = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        StateHasChanged();

        _totalRequests = await RequestRepository.GetTotalCountAsync();
        _queuedRequests = await RequestRepository.GetQueuedRequestsCountAsync();
        
        var completedList = await RequestRepository.GetByStatusAsync(ProcessingStatus.Completed);
        _completedRequests = completedList.Count();
        
        _totalBatches = await BatchJobRepository.GetTotalCountAsync();
        _recentRequests = (await RequestRepository.GetRecentRequestsAsync(10)).ToList();

        _loading = false;
        StateHasChanged();
    }

    private static string GetStatusBadgeClass(ProcessingStatus status) => status switch
    {
        ProcessingStatus.Pending => "bg-secondary",
        ProcessingStatus.Queued => "bg-warning text-dark",
        ProcessingStatus.Processing => "bg-info",
        ProcessingStatus.Completed => "bg-success",
        ProcessingStatus.Failed => "bg-danger",
        ProcessingStatus.BatchSubmitted => "bg-primary",
        _ => "bg-secondary"
    };
}
