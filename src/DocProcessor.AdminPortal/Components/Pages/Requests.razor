@page "/requests"
@page "/requests/{RequestId}"
@using DocProcessor.Core.Entities
@using DocProcessor.Core.Enums
@using DocProcessor.Core.Interfaces
@inject IDocumentRequestRepository RequestRepository
@rendermode InteractiveServer

<PageTitle>Requests - Document Processor Admin</PageTitle>

@if (string.IsNullOrEmpty(RequestId))
{
    <h1>All Requests</h1>

    <div class="mb-3">
        <div class="btn-group" role="group">
            <button class="btn @(_statusFilter == null ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(null)">All</button>
            <button class="btn @(_statusFilter == ProcessingStatus.Pending ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(ProcessingStatus.Pending)">Pending</button>
            <button class="btn @(_statusFilter == ProcessingStatus.Queued ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(ProcessingStatus.Queued)">Queued</button>
            <button class="btn @(_statusFilter == ProcessingStatus.Processing ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(ProcessingStatus.Processing)">Processing</button>
            <button class="btn @(_statusFilter == ProcessingStatus.Completed ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(ProcessingStatus.Completed)">Completed</button>
            <button class="btn @(_statusFilter == ProcessingStatus.Failed ? "btn-primary" : "btn-outline-primary")" @onclick="() => FilterByStatus(ProcessingStatus.Failed)">Failed</button>
        </div>
    </div>

    @if (_loading)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Document</th>
                    <th>Mode</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Completed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var request in _requests)
                {
                    <tr>
                        <td><code>@request.Id[..8]...</code></td>
                        <td>@request.DocumentName</td>
                        <td>@request.ProcessingMode</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(request.Status)">
                                @request.Status
                            </span>
                        </td>
                        <td>@request.CreatedAt.ToString("g")</td>
                        <td>@(request.CompletedAt?.ToString("g") ?? "-")</td>
                        <td>
                            <a href="requests/@request.Id" class="btn btn-sm btn-outline-primary">View</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center">
            <span>Showing @_requests.Count of @_totalCount requests</span>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" disabled="@(_skip == 0)" @onclick="PreviousPage">Previous</button>
                <button class="btn btn-outline-secondary" disabled="@(_requests.Count < _take)" @onclick="NextPage">Next</button>
            </div>
        </div>
    }
}
else
{
    @if (_selectedRequest == null)
    {
        <div class="alert alert-warning">Request not found</div>
        <a href="requests" class="btn btn-secondary">Back to Requests</a>
    }
    else
    {
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="requests">Requests</a></li>
                <li class="breadcrumb-item active">@_selectedRequest.Id[..8]...</li>
            </ol>
        </nav>

        <h1>Request Details</h1>

        <div class="card mb-3">
            <div class="card-header">
                <h5>General Information</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Request ID</dt>
                    <dd class="col-sm-9"><code>@_selectedRequest.Id</code></dd>

                    <dt class="col-sm-3">Document Name</dt>
                    <dd class="col-sm-9">@_selectedRequest.DocumentName</dd>

                    <dt class="col-sm-3">Document Type</dt>
                    <dd class="col-sm-9">@_selectedRequest.DocumentType</dd>

                    <dt class="col-sm-3">Processing Mode</dt>
                    <dd class="col-sm-9">@_selectedRequest.ProcessingMode</dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge @GetStatusBadgeClass(_selectedRequest.Status)">
                            @_selectedRequest.Status
                        </span>
                    </dd>

                    <dt class="col-sm-3">Created At</dt>
                    <dd class="col-sm-9">@_selectedRequest.CreatedAt.ToString("F")</dd>

                    <dt class="col-sm-3">Completed At</dt>
                    <dd class="col-sm-9">@(_selectedRequest.CompletedAt?.ToString("F") ?? "-")</dd>

                    @if (!string.IsNullOrEmpty(_selectedRequest.BatchId))
                    {
                        <dt class="col-sm-3">Batch ID</dt>
                        <dd class="col-sm-9"><a href="batches/@_selectedRequest.BatchId">@_selectedRequest.BatchId[..8]...</a></dd>
                    }

                    @if (!string.IsNullOrEmpty(_selectedRequest.CallbackUrl))
                    {
                        <dt class="col-sm-3">Callback URL</dt>
                        <dd class="col-sm-9">@_selectedRequest.CallbackUrl</dd>
                    }

                    <dt class="col-sm-3">Retry Count</dt>
                    <dd class="col-sm-9">@_selectedRequest.RetryCount</dd>
                </dl>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5>Instruction</h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3">@_selectedRequest.Instruction</pre>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                <h5>JSON Schema</h5>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3"><code>@FormatJson(_selectedRequest.JsonSchema)</code></pre>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_selectedRequest.Result))
        {
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5>Result</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3"><code>@_selectedRequest.Result</code></pre>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(_selectedRequest.ErrorMessage))
        {
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <h5>Error</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 text-danger">@_selectedRequest.ErrorMessage</pre>
                </div>
            </div>
        }

        <a href="requests" class="btn btn-secondary">Back to Requests</a>
    }
}

@code {
    [Parameter]
    public string? RequestId { get; set; }

    private bool _loading = true;
    private List<DocumentRequest> _requests = [];
    private DocumentRequest? _selectedRequest;
    private long _totalCount;
    private int _skip;
    private readonly int _take = 20;
    private ProcessingStatus? _statusFilter;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(RequestId))
        {
            _selectedRequest = await RequestRepository.GetByIdAsync(RequestId);
        }
        else
        {
            await LoadRequestsAsync();
        }
        _loading = false;
    }

    private async Task LoadRequestsAsync()
    {
        _loading = true;
        StateHasChanged();

        if (_statusFilter.HasValue)
        {
            var filtered = await RequestRepository.GetByStatusAsync(_statusFilter.Value);
            _requests = filtered.Skip(_skip).Take(_take).ToList();
            _totalCount = filtered.Count();
        }
        else
        {
            _requests = (await RequestRepository.GetAllAsync(_skip, _take)).ToList();
            _totalCount = await RequestRepository.GetTotalCountAsync();
        }

        _loading = false;
        StateHasChanged();
    }

    private async Task FilterByStatus(ProcessingStatus? status)
    {
        _statusFilter = status;
        _skip = 0;
        await LoadRequestsAsync();
    }

    private async Task PreviousPage()
    {
        _skip = Math.Max(0, _skip - _take);
        await LoadRequestsAsync();
    }

    private async Task NextPage()
    {
        _skip += _take;
        await LoadRequestsAsync();
    }

    private static string GetStatusBadgeClass(ProcessingStatus status) => status switch
    {
        ProcessingStatus.Pending => "bg-secondary",
        ProcessingStatus.Queued => "bg-warning text-dark",
        ProcessingStatus.Processing => "bg-info",
        ProcessingStatus.Completed => "bg-success",
        ProcessingStatus.Failed => "bg-danger",
        ProcessingStatus.BatchSubmitted => "bg-primary",
        _ => "bg-secondary"
    };

    private static string FormatJson(string? json)
    {
        if (string.IsNullOrWhiteSpace(json))
            return string.Empty;

        try
        {
            var jsonElement = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(json);
            return System.Text.Json.JsonSerializer.Serialize(jsonElement, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }
}
